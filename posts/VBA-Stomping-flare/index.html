<!DOCTYPE html>









<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en"
  
    data-mode="dark"
  
>

  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  
    

    
  

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="VBA Stomping: The macro hidden in plain sight" />
<meta property="og:locale" content="en" />
<meta name="description" content="At Flare-on 7th there was a very interesting malware analysis challenge that envolved a very unique hide technique for malicious Macros. This technique is called VBA Stomp, this works by hiding the real source code compiled in P-Code, the “bytecode” used in macros, and then making the visible source code as a fake one, if the malicious crafted document run in the same version that was previously compiled, the p-code will be executed." />
<meta property="og:description" content="At Flare-on 7th there was a very interesting malware analysis challenge that envolved a very unique hide technique for malicious Macros. This technique is called VBA Stomp, this works by hiding the real source code compiled in P-Code, the “bytecode” used in macros, and then making the visible source code as a fake one, if the malicious crafted document run in the same version that was previously compiled, the p-code will be executed." />
<link rel="canonical" href="https://reversing.codes/posts/VBA-Stomping-flare/" />
<meta property="og:url" content="https://reversing.codes/posts/VBA-Stomping-flare/" />
<meta property="og:site_name" content="Reversing codes" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-10-23T20:23:36-03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="VBA Stomping: The macro hidden in plain sight" />
<meta name="twitter:site" content="@buzz3r_" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-02-12T04:32:06-03:00","datePublished":"2020-10-23T20:23:36-03:00","description":"At Flare-on 7th there was a very interesting malware analysis challenge that envolved a very unique hide technique for malicious Macros. This technique is called VBA Stomp, this works by hiding the real source code compiled in P-Code, the “bytecode” used in macros, and then making the visible source code as a fake one, if the malicious crafted document run in the same version that was previously compiled, the p-code will be executed.","headline":"VBA Stomping: The macro hidden in plain sight","mainEntityOfPage":{"@type":"WebPage","@id":"https://reversing.codes/posts/VBA-Stomping-flare/"},"url":"https://reversing.codes/posts/VBA-Stomping-flare/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>VBA Stomping: The macro hidden in plain sight | Reversing codes
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Reversing codes">
<meta name="application-name" content="Reversing codes">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/style.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"></script>

  
</head>


  <body data-topbar-visible="true">

    <!--
  The Side Bar
-->
<style>
  body {
      text-align: justify;
  }
  </style>
  
<div id="sidebar" class="d-flex flex-column align-items-end">
  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" class="mx-auto">
        
          
          <img src="https://avatars.githubusercontent.com/u/22428720" alt="avatar" onerror="this.style.display='none'">
        
      </a>
    </div>

    <div class="site-title">
      <a href="/">Buzzer's blog</a>
    </div>
    <div class="site-subtitle font-italic">Security Researcher & Dreamer</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">

    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center">

    

    
      

      
      <a href="https://github.com/buzzer-re" aria-label="github"
        
        
          
          target="_blank"
        

        

        rel="noopener">
        <i class="fab fa-github"></i>
      </a>
      

    
      

      
      <a href="https://twitter.com/buzz3r_" aria-label="twitter"
        
        
          
          target="_blank"
        

        

        rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
      

    
      

      
      <a href="/feed.xml" aria-label="rss"
        
        

        

        >
        <i class="fas fa-rss"></i>
      </a>
      

    

  </div> <!-- .sidebar-bottom -->

      <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V8QSGFHYFB"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        id = 'G-V8QSGFHYFB'
        gtag('config', id);
    </script>
</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper">
  <div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4">
    <span id="breadcrumb">

    

    

      

        
          <span>
            <a href="/">
              Home
            </a>
          </span>

        

      

        

      

        

          
            <span>VBA Stomping: The macro hidden in plain sight</span>
          

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div id="main" class="container pl-xl-4 pr-xl-4">
        





<div class="row">

  <!-- core -->
  <div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4">
    <div class="post pl-1 pr-1 pl-md-2 pr-md-2">

    

    
      
      
        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->


<!-- images -->




  
  

  <!-- CDN URL -->
  

  <!-- Add image path -->
  

  
    
      
      
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  

  



<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  

  
  

  

  
  

  




<!-- return -->

<h1 data-toc-skip>VBA Stomping: The macro hidden in plain sight</h1>

<div class="post-meta text-muted">
    <!-- published date -->
    <span>
      Posted
      <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class=""
    data-ts="1603495416"
    data-df="ll"
    data-toggle="tooltip" data-placement="bottom">
  Oct 23, 2020
</em>

    </span>

    <!-- lastmod date -->
    
    <span>
      Updated
      <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class=""
    data-ts="1676187126"
    data-df="ll"
    data-toggle="tooltip" data-placement="bottom">
  Feb 12, 2023
</em>

    </span>
    

  

  <div class="d-flex justify-content-between">
    <!-- author(s) -->
    <span>
      

      By

      <em>
      
        <a href="https://github.com/buzzer-re">Buzzer</a>
      
      </em>
    </span>

    <div>
      <!-- page views -->
      

      <!-- read time -->
      <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->



<!-- words per minute  -->










<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom"
  title="2682 words">
  <em>14 min</em> read</span>

    </div>

  </div> <!-- .d-flex -->

</div> <!-- .post-meta -->

<div class="post-content">
  <p>At <a href="https://www.fireeye.com/blog/threat-research/2020/08/announcing-the-seventh-annual-flare-on-challenge.html">Flare-on 7th</a> there was a very interesting malware analysis challenge that envolved a very unique hide technique for malicious Macros. This technique is called <a href="https://vbastomp.com/">VBA Stomp</a>, this works by hiding the real source code compiled in <a href="https://en.wikipedia.org/wiki/P-code_machine">P-Code</a>, the “bytecode” used in macros, and then making the visible source code as a fake one, if the malicious crafted document run in the same version that was previously compiled, the p-code will be executed.</p>

<h1 id="why-is-this-useful-">Why is this useful ?</h1>

<h2 id="document-analysis"><span class="mr-2">Document analysis</span><a href="#document-analysis" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Even more, malwares are embedded in documents, this challenge explores how can a malware can inject a malicious code and abuse from VBA macros to exploit machines.</p>

<h2 id="advanced-evasion-technique"><span class="mr-2">Advanced evasion technique</span><a href="#advanced-evasion-technique" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>VBA Stomp is the key of this challenge, and in my humble opinion, a amazing injection technique. The source code literally does not exists in plain text, we must go deeper in order to acomplish the real malware intentions.</p>

<p>I was fooled in that challenge, and I want to share my write-up to solve this one, check it out.</p>

<p>Challenge Message:</p>

<p><strong><em>Nobody likes analysing infected documents, but it pays the bills. Reverse this macro thrill-ride to discover how to get it to show you the key.</em></strong></p>

<p>In this challenge we need to analyse a malicious xls document that contain a malicious macro and make use modern and advanced techniques.</p>

<h1 id="recon">Recon</h1>

<p>Documents like xls, make use of <a href="https://docs.microsoft.com/en-us/cpp/mfc/ole-background?view=vs-2019">OLE</a> format, that format store documents, “folder” and bytes streams, its mainly used for documents like, docx, xlsx and others.</p>

<p>I will use <a href="https://securityonline.info/oletools/">oletools</a> to get some internal file informations, such all the streams and VBA projects inside this document, before open the document itself.</p>

<h2 id="oledump"><span class="mr-2">Oledump</span><a href="#oledump" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>We can use oledump to get all the streams in the OLE file (document)</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre>Z:\Projects\CTF\FlareOn2020\report&gt;oledump.py -v report.xls
  1:       108 '\x01CompObj'
  2:       244 '\x05DocumentSummaryInformation'
3:    352240 'Workbook'
4:        97 '_VBA_PROJECT_CUR/F/\x01CompObj'
  5:       284 '_VBA_PROJECT_CUR/F/\x03VBFrame'
  6:       163 '_VBA_PROJECT_CUR/F/f'
  7:   1143744 '_VBA_PROJECT_CUR/F/o'
  8:       534 '_VBA_PROJECT_CUR/PROJECT'
  9:        68 '_VBA_PROJECT_CUR/PROJECTwm'
 10: m    1388 '_VBA_PROJECT_CUR/VBA/F'
 11:     10518 '_VBA_PROJECT_CUR/VBA/Sheet1'
 12: M    1785 '_VBA_PROJECT_CUR/VBA/ThisWorkbook'
 13:      4327 '_VBA_PROJECT_CUR/VBA/_VBA_PROJECT'
 14:      3345 '_VBA_PROJECT_CUR/VBA/__SRP_0'
 15:       486 '_VBA_PROJECT_CUR/VBA/__SRP_1'
 16:       592 '_VBA_PROJECT_CUR/VBA/__SRP_2'
 17:       140 '_VBA_PROJECT_CUR/VBA/__SRP_3'
 18:      3158 '_VBA_PROJECT_CUR/VBA/__SRP_4'
 19:       473 '_VBA_PROJECT_CUR/VBA/__SRP_5'
 20:       448 '_VBA_PROJECT_CUR/VBA/__SRP_6'
 21:        66 '_VBA_PROJECT_CUR/VBA/__SRP_7'
 22:       827 '_VBA_PROJECT_CUR/VBA/dir'
</pre></td></tr></tbody></table></code></div></div>

<p>We can see that we have VBA code at 10 and 12 streams, denoted by letter <strong><em>M</em></strong>, let’s dump that:</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre> Z:\Projects\CTF\FlareOn2020\report&gt;oledump.py -v report.xls -v -e -s10
Attribute VB_Name = "F"
Attribute VB_Base = "0{4CAFACAA-2A4D-41F3-9B86-24F5964089BB}{A9F6A711-2CEB-4939-941D-EAC47AFB9092}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False

Z:\Projects\CTF\FlareOn2020\report&gt;oledump.py -v report.xls -v -e -s 12
Attribute VB_Name = "ThisWorkbook"
Attribute VB_Base = "0{00020819-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Sub Workbook_Open()
Sheet1.folderol
End Sub

Sub Auto_Open()
Sheet1.folderol
End Sub
</pre></td></tr></tbody></table></code></div></div>

<p>Notice that we have 2 VBA projects here, project <strong><em>F</em></strong> and project <strong><em>ThisWorkBook</em></strong>, but the script source was at <strong><em>Sheet1</em></strong>, take a look at the open function:</p>

<div class="language-java highlighter-rouge"><div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nc">Sub</span> <span class="nf">Workbook_Open</span><span class="o">()</span>
<span class="nc">Sheet1</span><span class="o">.</span><span class="na">folderol</span>
<span class="nc">End</span> <span class="nc">Sub</span>
</pre></td></tr></tbody></table></code></div></div>

<p>But the oledump was very vague here, we just know that something called <strong><em>Sheet1.folderol</em></strong> is being called when the macro run, let’s dump the whole code using <strong><em>olevba</em></strong></p>

<h2 id="olevba"><span class="mr-2">Olevba</span><a href="#olevba" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>olevba report.xls &gt; output
</pre></td></tr></tbody></table></code></div></div>
<p>That give to us a lot of useful information about the VB code inside, but I will stick in <strong><em>Sheet1</em></strong> code, because it’s where the function <strong><em>folderol</em></strong> is found.</p>

<div class="language-java highlighter-rouge"><div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
</pre></td><td class="rouge-code"><pre><span class="nc">Private</span> <span class="nc">Declare</span> <span class="nc">Function</span> <span class="nc">InternetGetConnectedState</span> <span class="nc">Lib</span> <span class="s">"wininet.dll"</span> <span class="n">_</span>
<span class="o">(</span><span class="nc">ByRef</span> <span class="n">dwflags</span> <span class="nc">As</span> <span class="nc">Long</span><span class="o">,</span> <span class="nc">ByVal</span> <span class="n">dwReserved</span> <span class="nc">As</span> <span class="nc">Long</span><span class="o">)</span> <span class="nc">As</span> <span class="nc">Long</span>

<span class="nc">Private</span> <span class="nc">Declare</span> <span class="nc">PtrSafe</span> <span class="nc">Function</span> <span class="n">mciSendString</span> <span class="nc">Lib</span> <span class="s">"winmm.dll"</span> <span class="nc">Alias</span> <span class="n">_</span>
   <span class="s">"mciSendStringA"</span> <span class="o">(</span><span class="nc">ByVal</span> <span class="n">lpstrCommand</span> <span class="nc">As</span> <span class="nc">String</span><span class="o">,</span> <span class="nc">ByVal</span> <span class="n">_</span>
   <span class="n">lpstrReturnString</span> <span class="nc">As</span> <span class="nc">Any</span><span class="o">,</span> <span class="nc">ByVal</span> <span class="n">uReturnLength</span> <span class="nc">As</span> <span class="nc">Long</span><span class="o">,</span> <span class="nc">ByVal</span> <span class="n">_</span>
   <span class="n">hwndCallback</span> <span class="nc">As</span> <span class="nc">Long</span><span class="o">)</span> <span class="nc">As</span> <span class="nc">Long</span>

<span class="nc">Private</span> <span class="nc">Declare</span> <span class="nc">Function</span> <span class="nc">GetShortPathName</span> <span class="nc">Lib</span> <span class="s">"kernel32"</span> <span class="nc">Alias</span> <span class="s">"GetShortPathNameA"</span> <span class="n">_</span>
    <span class="o">(</span><span class="nc">ByVal</span> <span class="n">lpszLongPath</span> <span class="nc">As</span> <span class="nc">String</span><span class="o">,</span> <span class="nc">ByVal</span> <span class="n">lpszShortPath</span> <span class="nc">As</span> <span class="nc">String</span><span class="o">,</span> <span class="nc">ByVal</span> <span class="n">lBuffer</span> <span class="nc">As</span> <span class="nc">Long</span><span class="o">)</span> <span class="nc">As</span> <span class="nc">Long</span>

<span class="nc">Public</span> <span class="nc">Function</span> <span class="nf">GetInternetConnectedState</span><span class="o">()</span> <span class="nc">As</span> <span class="nc">Boolean</span>
  <span class="nc">GetInternetConnectedState</span> <span class="o">=</span> <span class="nc">InternetGetConnectedState</span><span class="o">(</span><span class="mi">0</span><span class="o">&amp;,</span> <span class="mi">0</span><span class="o">&amp;)</span>
<span class="nc">End</span> <span class="nc">Function</span>

<span class="nc">Function</span> <span class="nf">rigmarole</span><span class="o">(</span><span class="n">es</span> <span class="nc">As</span> <span class="nc">String</span><span class="o">)</span> <span class="nc">As</span> <span class="nc">String</span>
    <span class="nc">Dim</span> <span class="n">furphy</span> <span class="nc">As</span> <span class="nc">String</span>
    <span class="nc">Dim</span> <span class="n">c</span> <span class="nc">As</span> <span class="nc">Integer</span>
    <span class="nc">Dim</span> <span class="n">s</span> <span class="nc">As</span> <span class="nc">String</span>
    <span class="nc">Dim</span> <span class="n">cc</span> <span class="nc">As</span> <span class="nc">Integer</span>
    <span class="n">furphy</span> <span class="o">=</span> <span class="s">""</span>
    <span class="nc">For</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="nc">To</span> <span class="nf">Len</span><span class="o">(</span><span class="n">es</span><span class="o">)</span> <span class="nc">Step</span> <span class="mi">4</span>
        <span class="n">c</span> <span class="o">=</span> <span class="nc">CDec</span><span class="o">(</span><span class="s">"&amp;H"</span> <span class="o">&amp;</span> <span class="nc">Mid</span><span class="o">(</span><span class="n">es</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nc">CDec</span><span class="o">(</span><span class="s">"&amp;H"</span> <span class="o">&amp;</span> <span class="nc">Mid</span><span class="o">(</span><span class="n">es</span><span class="o">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="n">s</span>
        <span class="n">furphy</span> <span class="o">=</span> <span class="n">furphy</span> <span class="o">+</span> <span class="nc">Chr</span><span class="o">(</span><span class="n">cc</span><span class="o">)</span>
    <span class="nc">Next</span> <span class="n">i</span>
    <span class="n">rigmarole</span> <span class="o">=</span> <span class="n">furphy</span>
<span class="nc">End</span> <span class="nc">Function</span>

<span class="nc">Function</span> <span class="nf">folderol</span><span class="o">()</span>
    <span class="nc">Dim</span> <span class="nf">wabbit</span><span class="o">()</span> <span class="nc">As</span> <span class="nc">Byte</span>
    <span class="nc">Dim</span> <span class="n">fn</span> <span class="nc">As</span> <span class="nl">Integer:</span> <span class="n">fn</span> <span class="o">=</span> <span class="nc">FreeFile</span>
    <span class="nc">Dim</span> <span class="nf">onzo</span><span class="o">()</span> <span class="nc">As</span> <span class="nc">String</span>
    <span class="nc">Dim</span> <span class="n">mf</span> <span class="nc">As</span> <span class="nc">String</span>
    <span class="nc">Dim</span> <span class="n">xertz</span> <span class="nc">As</span> <span class="nc">Variant</span>
    
    <span class="n">onzo</span> <span class="o">=</span> <span class="nc">Split</span><span class="o">(</span><span class="no">F</span><span class="o">.</span><span class="na">L</span><span class="o">,</span> <span class="s">"."</span><span class="o">)</span>
    
    <span class="nc">If</span> <span class="nc">GetInternetConnectedState</span> <span class="o">=</span> <span class="nc">False</span> <span class="nc">Then</span>
        <span class="nc">MsgBox</span> <span class="s">"Cannot establish Internet connection."</span><span class="o">,</span> <span class="n">vbCritical</span><span class="o">,</span> <span class="s">"Error"</span>
        <span class="nc">End</span>
    <span class="nc">End</span> <span class="nc">If</span>

    <span class="nc">Set</span> <span class="n">fudgel</span> <span class="o">=</span> <span class="nc">GetObject</span><span class="o">(</span><span class="n">rigmarole</span><span class="o">(</span><span class="n">onzo</span><span class="o">(</span><span class="mi">7</span><span class="o">)))</span>
    <span class="nc">Set</span> <span class="n">twattling</span> <span class="o">=</span> <span class="n">fudgel</span><span class="o">.</span><span class="na">ExecQuery</span><span class="o">(</span><span class="n">rigmarole</span><span class="o">(</span><span class="n">onzo</span><span class="o">(</span><span class="mi">8</span><span class="o">)),</span> <span class="o">,</span> <span class="mi">48</span><span class="o">)</span>
    <span class="nc">For</span> <span class="nc">Each</span> <span class="n">p</span> <span class="nc">In</span> <span class="n">twattling</span>
        <span class="nc">Dim</span> <span class="n">pos</span> <span class="nc">As</span> <span class="nc">Integer</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="nc">InStr</span><span class="o">(</span><span class="nc">LCase</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">Name</span><span class="o">),</span> <span class="s">"vmw"</span><span class="o">)</span> <span class="o">+</span> <span class="nc">InStr</span><span class="o">(</span><span class="nc">LCase</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">Name</span><span class="o">),</span> <span class="s">"vmt"</span><span class="o">)</span> <span class="o">+</span> <span class="nc">InStr</span><span class="o">(</span><span class="nc">LCase</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">Name</span><span class="o">),</span> <span class="n">rigmarole</span><span class="o">(</span><span class="n">onzo</span><span class="o">(</span><span class="mi">9</span><span class="o">)))</span>
        <span class="nc">If</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="nc">Then</span>
            <span class="nc">MsgBox</span> <span class="nf">rigmarole</span><span class="o">(</span><span class="n">onzo</span><span class="o">(</span><span class="mi">4</span><span class="o">)),</span> <span class="n">vbCritical</span><span class="o">,</span> <span class="n">rigmarole</span><span class="o">(</span><span class="n">onzo</span><span class="o">(</span><span class="mi">6</span><span class="o">))</span>
            <span class="nc">End</span>
        <span class="nc">End</span> <span class="nc">If</span>
    <span class="nc">Next</span>
        
    <span class="n">xertz</span> <span class="o">=</span> <span class="nc">Array</span><span class="o">(&amp;</span><span class="no">H11</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">H22</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">H33</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">H44</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">H55</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">H66</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">H77</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">H88</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">H99</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">HAA</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">HBB</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">HCC</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">HDD</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">HEE</span><span class="o">)</span>

    <span class="n">wabbit</span> <span class="o">=</span> <span class="n">canoodle</span><span class="o">(</span><span class="no">F</span><span class="o">.</span><span class="na">T</span><span class="o">.</span><span class="na">Text</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">168667</span><span class="o">,</span> <span class="n">xertz</span><span class="o">)</span>
    <span class="n">mf</span> <span class="o">=</span> <span class="nc">Environ</span><span class="o">(</span><span class="n">rigmarole</span><span class="o">(</span><span class="n">onzo</span><span class="o">(</span><span class="mi">0</span><span class="o">)))</span> <span class="o">&amp;</span> <span class="n">rigmarole</span><span class="o">(</span><span class="n">onzo</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
    <span class="nc">Open</span> <span class="n">mf</span> <span class="nc">For</span> <span class="nc">Binary</span> <span class="nc">Lock</span> <span class="nc">Read</span> <span class="nc">Write</span> <span class="nc">As</span> <span class="err">#</span><span class="n">fn</span>
      <span class="nc">Put</span> <span class="err">#</span><span class="n">fn</span><span class="o">,</span> <span class="o">,</span> <span class="n">wabbit</span>
    <span class="nc">Close</span> <span class="err">#</span><span class="n">fn</span>
    
    <span class="n">mucolerd</span> <span class="o">=</span> <span class="n">mciSendString</span><span class="o">(</span><span class="n">rigmarole</span><span class="o">(</span><span class="n">onzo</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span> <span class="o">&amp;</span> <span class="n">mf</span><span class="o">,</span> <span class="mi">0</span><span class="o">&amp;,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
<span class="nc">End</span> <span class="nc">Function</span>

<span class="nc">Function</span> <span class="nf">canoodle</span><span class="o">(</span><span class="n">panjandrum</span> <span class="nc">As</span> <span class="nc">String</span><span class="o">,</span> <span class="n">ardylo</span> <span class="nc">As</span> <span class="nc">Integer</span><span class="o">,</span> <span class="n">s</span> <span class="nc">As</span> <span class="nc">Long</span><span class="o">,</span> <span class="n">bibble</span> <span class="nc">As</span> <span class="nc">Variant</span><span class="o">)</span> <span class="nc">As</span> <span class="nf">Byte</span><span class="o">()</span>
    <span class="nc">Dim</span> <span class="n">quean</span> <span class="nc">As</span> <span class="nc">Long</span>
    <span class="nc">Dim</span> <span class="n">cattywampus</span> <span class="nc">As</span> <span class="nc">Long</span>
    <span class="nc">Dim</span> <span class="nf">kerfuffle</span><span class="o">()</span> <span class="nc">As</span> <span class="nc">Byte</span>
    <span class="nc">ReDim</span> <span class="nf">kerfuffle</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
    <span class="n">quean</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nc">For</span> <span class="n">cattywampus</span> <span class="o">=</span> <span class="mi">1</span> <span class="nc">To</span> <span class="nf">Len</span><span class="o">(</span><span class="n">panjandrum</span><span class="o">)</span> <span class="nc">Step</span> <span class="mi">4</span>
        <span class="n">kerfuffle</span><span class="o">(</span><span class="n">quean</span><span class="o">)</span> <span class="o">=</span> <span class="nc">CByte</span><span class="o">(</span><span class="s">"&amp;H"</span> <span class="o">&amp;</span> <span class="nc">Mid</span><span class="o">(</span><span class="n">panjandrum</span><span class="o">,</span> <span class="n">cattywampus</span> <span class="o">+</span> <span class="n">ardylo</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="nc">Xor</span> <span class="nf">bibble</span><span class="o">(</span><span class="n">quean</span> <span class="nf">Mod</span> <span class="o">(</span><span class="nc">UBound</span><span class="o">(</span><span class="n">bibble</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span>
        <span class="n">quean</span> <span class="o">=</span> <span class="n">quean</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="nc">If</span> <span class="n">quean</span> <span class="o">=</span> <span class="nc">UBound</span><span class="o">(</span><span class="n">kerfuffle</span><span class="o">)</span> <span class="nc">Then</span>
            <span class="nc">Exit</span> <span class="nc">For</span>
        <span class="nc">End</span> <span class="nc">If</span>
    <span class="nc">Next</span> <span class="n">cattywampus</span>
    <span class="n">canoodle</span> <span class="o">=</span> <span class="n">kerfuffle</span>
<span class="nc">End</span> <span class="nc">Function</span>

</pre></td></tr></tbody></table></code></div></div>

<p>In folderol function, we see that the function Split is being called with the VBName F, and access F.T, but F macro is shown as empty, let’s investigate:</p>

<h1 id="decoding-strings">Decoding strings</h1>

<p>The <strong><em>F</em></strong> variable is a reference to a VBA form, you can see that is a simple user interface with encoded and encrypted data, take a look</p>

<p><a href="/assets/images/vbastomping_flare_7/F_form.png" class="popup img-link "><img data-src="/assets/images/vbastomping_flare_7/F_form.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>I also used <a href="https://www.mitec.cz/ssv.html">ssviewer</a> to interpret the ole file itself, and I found in the stream <strong><em>o</em></strong> the same data in the form.</p>

<p><a href="/assets/images/vbastomping_flare_7/FHex.png" class="popup img-link "><img data-src="/assets/images/vbastomping_flare_7/FHex.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>Here we can see that we have some encoded data divided by “<strong><em>.</em></strong>”, this will give us a list of encoded strings, and each time that the malware wants to access an string, it calls the  <strong><em>rigmarole</em></strong> function, this function get the string in hex representation, and subtract the second byte for the first, jumping 2 bytes each time.</p>

<p>Rigmarole function:</p>

<div class="language-java highlighter-rouge"><div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="nc">Function</span> <span class="nf">rigmarole</span><span class="o">(</span><span class="n">es</span> <span class="nc">As</span> <span class="nc">String</span><span class="o">)</span> <span class="nc">As</span> <span class="nc">String</span>
    <span class="nc">Dim</span> <span class="n">furphy</span> <span class="nc">As</span> <span class="nc">String</span>
    <span class="nc">Dim</span> <span class="n">c</span> <span class="nc">As</span> <span class="nc">Integer</span>
    <span class="nc">Dim</span> <span class="n">s</span> <span class="nc">As</span> <span class="nc">String</span>
    <span class="nc">Dim</span> <span class="n">cc</span> <span class="nc">As</span> <span class="nc">Integer</span>
    <span class="n">furphy</span> <span class="o">=</span> <span class="s">""</span>
    <span class="nc">For</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="nc">To</span> <span class="nf">Len</span><span class="o">(</span><span class="n">es</span><span class="o">)</span> <span class="nc">Step</span> <span class="mi">4</span>
        <span class="n">c</span> <span class="o">=</span> <span class="nc">CDec</span><span class="o">(</span><span class="s">"&amp;H"</span> <span class="o">&amp;</span> <span class="nc">Mid</span><span class="o">(</span><span class="n">es</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nc">CDec</span><span class="o">(</span><span class="s">"&amp;H"</span> <span class="o">&amp;</span> <span class="nc">Mid</span><span class="o">(</span><span class="n">es</span><span class="o">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="n">s</span>
        <span class="n">furphy</span> <span class="o">=</span> <span class="n">furphy</span> <span class="o">+</span> <span class="nc">Chr</span><span class="o">(</span><span class="n">cc</span><span class="o">)</span>
    <span class="nc">Next</span> <span class="n">i</span>
    <span class="n">rigmarole</span> <span class="o">=</span> <span class="n">furphy</span>
<span class="nc">End</span> <span class="nc">Function</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Now we ca just split the same way that the malware do and run the same decode algorithm, here is the decode algorithm in python:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>

<span class="k">def</span> <span class="nf">decode_string</span><span class="p">(</span><span class="n">encoded_string</span><span class="p">):</span>
	<span class="n">out</span> <span class="o">=</span> <span class="sh">""</span>
	<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">encoded_string</span><span class="p">),</span> <span class="mi">4</span><span class="p">):</span>
		<span class="n">c</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">encoded_string</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">encoded_string</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">s</span><span class="o">+</span><span class="mi">4</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

		<span class="n">cc</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="n">s</span>
		<span class="n">out</span> <span class="o">+=</span> <span class="nf">chr</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">out</span>	


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
	<span class="n">encoded_values</span> <span class="o">=</span>  <span class="sh">"</span><span class="s">9655B040B64667238524D15D6201.B95D4E01C55CC562C7557405A532D768C55FA12DD074DC697A06E172992CAF3F8A5C7306B7476B38.C555AC40A7469C234424.853FA85C470699477D3851249A4B9C4E.A855AF40B84695239D24895D2101D05CCA62BE5578055232D568C05F902DDC74D2697406D7724C2CA83FCF5C2606B547A73898246B4BC14E941F9121D464D263B947EB77D36E7F1B8254.853FA85C470699477D3851249A4B9C4E.9A55B240B84692239624.CC55A940B44690238B24CA5D7501CF5C9C62B15561056032C468D15F9C2DE374DD696206B572752C8C3FB25C3806.A8558540924668236724B15D2101AA5CC362C2556A055232AE68B15F7C2DC17489695D06DB729A2C723F8E5C65069747AA389324AE4BB34E921F9421.CB55A240B5469B23.AC559340A94695238D24CD5D75018A5CB062BA557905A932D768D15F982D.D074B6696F06D5729E2CAE3FCF5C7506AD47AC388024C14B7C4E8F1F8F21CB64</span><span class="sh">"</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span>
	
	<span class="n">decoded_values</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">for</span> <span class="n">encoded</span> <span class="ow">in</span> <span class="n">encoded_values</span><span class="p">:</span>
		<span class="n">decoded_values</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">decode_string</span><span class="p">(</span><span class="n">encoded</span><span class="p">))</span>
	
	
	<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">decoded_values</span><span class="p">):</span>
		<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">decoded_table[{}] = {}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>	
<span class="p">)</span>

</pre></td></tr></tbody></table></code></div></div>

<p>This will give to us what I called, decoded_table, with this decoded strings it’s possible to interpret the code using the plain text strings.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre> python decode_strings.py
decoded_table[0] = AppData
decoded_table[1] = \Microsoft\stomp.mp3
decoded_table[2] = play 
decoded_table[3] = FLARE-ON
decoded_table[4] = Sorry, this machine is not supported.
decoded_table[5] = FLARE-ON
decoded_table[6] = Error
decoded_table[7] = winmgmts:\\.\root\CIMV2
decoded_table[8] = SELECT Name FROM Win32_Process
decoded_table[9] = vbox
decoded_table[10] = WScript.Network
decoded_table[11] = \Microsoft\v.png
]
</pre></td></tr></tbody></table></code></div></div>

<p>Now, let’s just continue to read the script and when the malware call the decode string function, we just look at our decoded table.</p>

<h2 id="the-evasion-system"><span class="mr-2">The evasion system</span><a href="#the-evasion-system" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>In the code below, we can see that the malware has a simple evade system, I already decoded all the <strong><em>ringmarole</em></strong> calls for the real string value.</p>

<div class="language-java highlighter-rouge"><div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre> <span class="nc">Set</span> <span class="n">fudgel</span> <span class="o">=</span> <span class="s">"winmgmts:\\.\root\CIMV2"</span>
 <span class="nc">Set</span> <span class="n">twattling</span> <span class="o">=</span> <span class="n">fudgel</span><span class="o">.</span><span class="na">ExecQuery</span><span class="o">(</span><span class="s">"SELECT Name FROM Win32_Process"</span><span class="o">)</span>

<span class="nc">For</span> <span class="nc">Each</span> <span class="n">p</span> <span class="nc">In</span> <span class="n">twattling</span>
    <span class="nc">Dim</span> <span class="n">pos</span> <span class="nc">As</span> <span class="nc">Integer</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="nc">InStr</span><span class="o">(</span><span class="nc">LCase</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">Name</span><span class="o">),</span> <span class="s">"vmw"</span><span class="o">)</span> <span class="o">+</span> <span class="nc">InStr</span><span class="o">(</span><span class="nc">LCase</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">Name</span><span class="o">),</span> <span class="s">"vmt"</span><span class="o">)</span> <span class="o">+</span> <span class="nc">InStr</span><span class="o">(</span><span class="nc">LCase</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">Name</span><span class="o">),</span> <span class="s">"vbox"</span><span class="o">)</span>
    <span class="nc">If</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="nc">Then</span>
        <span class="nc">MsgBox</span> <span class="nf">rigmarole</span><span class="o">(</span><span class="s">"Sorry, this machine is not supported"</span><span class="o">,</span> <span class="n">vbCritical</span><span class="o">,</span> <span class="s">"Error"</span><span class="o">)</span>

        <span class="nc">End</span>
    <span class="nc">End</span> <span class="nc">If</span>
<span class="nc">Next</span>
</pre></td></tr></tbody></table></code></div></div>

<p>In order words, this code makes a <a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page">wmi</a> query to get all running process, and then, if some process contain any trace that is in the virtualized enviroment, an alert box will appear.</p>

<h1 id="fake-stage-2-extraction">Fake Stage 2 extraction</h1>

<p>Using the decode table we can see when the second stage is dropped:</p>

<div class="language-java highlighter-rouge"><div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="err">#</span> <span class="n">key</span> <span class="o">?</span>
<span class="n">xertz</span> <span class="o">=</span> <span class="nc">Array</span><span class="o">(&amp;</span><span class="no">H11</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">H22</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">H33</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">H44</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">H55</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">H66</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">H77</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">H88</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">H99</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">HAA</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">HBB</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">HCC</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">HDD</span><span class="o">,</span> <span class="o">&amp;</span><span class="no">HEE</span><span class="o">)</span>

<span class="n">wabbit</span> <span class="o">=</span> <span class="n">canoodle</span><span class="o">(</span><span class="no">F</span><span class="o">.</span><span class="na">T</span><span class="o">.</span><span class="na">Text</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">168667</span><span class="o">,</span> <span class="n">xertz</span><span class="o">)</span>
<span class="n">mf</span> <span class="o">=</span> <span class="nc">Environ</span><span class="o">(</span><span class="s">"AppData"</span><span class="o">)</span> <span class="o">&amp;</span> <span class="s">"\Microsoft\stomp.mp3"</span>

<span class="nc">Open</span> <span class="n">mf</span> <span class="nc">For</span> <span class="nc">Binary</span> <span class="nc">Lock</span> <span class="nc">Read</span> <span class="nc">Write</span> <span class="nc">As</span> <span class="err">#</span><span class="n">fn</span>
    <span class="nc">Put</span> <span class="err">#</span><span class="n">fn</span><span class="o">,</span> <span class="o">,</span> <span class="n">wabbit</span>
<span class="nc">Close</span> <span class="err">#</span><span class="n">fn</span>

<span class="n">mucolerd</span> <span class="o">=</span> <span class="n">mciSendString</span><span class="o">(</span><span class="s">"play"</span> <span class="o">&amp;</span>  <span class="n">mf</span><span class="o">,</span> <span class="mi">0</span><span class="o">&amp;,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>So, the stage 1 will drop a file with <strong><em>.mp3</em></strong> extension, and use the <a href="https://docs.microsoft.com/en-us/previous-versions/dd757161(v=vs.85)">mciSendString</a> function to “play” that song, now we need to get the <strong><em>F.T.Text</em></strong> value and understand how the decryption process in <strong><em>canoodle</em></strong> function works.</p>

<h2 id="the-two-faces-of-l"><span class="mr-2">The two faces of L</span><a href="#the-two-faces-of-l" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>The function that decrypt the song is that:</p>

<div class="language-java highlighter-rouge"><div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="nc">Function</span> <span class="nf">canoodle</span><span class="o">(</span><span class="n">panjandrum</span> <span class="nc">As</span> <span class="nc">String</span><span class="o">,</span> <span class="n">ardylo</span> <span class="nc">As</span> <span class="nc">Integer</span><span class="o">,</span> <span class="n">s</span> <span class="nc">As</span> <span class="nc">Long</span><span class="o">,</span> <span class="n">bibble</span> <span class="nc">As</span> <span class="nc">Variant</span><span class="o">)</span> <span class="nc">As</span> <span class="nf">Byte</span><span class="o">()</span>
    <span class="nc">Dim</span> <span class="n">quean</span> <span class="nc">As</span> <span class="nc">Long</span>
    <span class="nc">Dim</span> <span class="n">cattywampus</span> <span class="nc">As</span> <span class="nc">Long</span>
    <span class="nc">Dim</span> <span class="nf">kerfuffle</span><span class="o">()</span> <span class="nc">As</span> <span class="nc">Byte</span>
    <span class="nc">ReDim</span> <span class="nf">kerfuffle</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
    <span class="n">quean</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nc">For</span> <span class="n">cattywampus</span> <span class="o">=</span> <span class="mi">1</span> <span class="nc">To</span> <span class="nf">Len</span><span class="o">(</span><span class="n">panjandrum</span><span class="o">)</span> <span class="nc">Step</span> <span class="mi">4</span>
        <span class="n">kerfuffle</span><span class="o">(</span><span class="n">quean</span><span class="o">)</span> <span class="o">=</span> <span class="nc">CByte</span><span class="o">(</span><span class="s">"&amp;H"</span> <span class="o">&amp;</span> <span class="nc">Mid</span><span class="o">(</span><span class="n">panjandrum</span><span class="o">,</span> <span class="n">cattywampus</span> <span class="o">+</span> <span class="n">ardylo</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="nc">Xor</span> <span class="nf">bibble</span><span class="o">(</span><span class="n">quean</span> <span class="nf">Mod</span> <span class="o">(</span><span class="nc">UBound</span><span class="o">(</span><span class="n">bibble</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span>
        <span class="n">quean</span> <span class="o">=</span> <span class="n">quean</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="nc">If</span> <span class="n">quean</span> <span class="o">=</span> <span class="nc">UBound</span><span class="o">(</span><span class="n">kerfuffle</span><span class="o">)</span> <span class="nc">Then</span>
            <span class="nc">Exit</span> <span class="nc">For</span>
        <span class="nc">End</span> <span class="nc">If</span>
    <span class="nc">Next</span> <span class="n">cattywampus</span>
    <span class="n">canoodle</span> <span class="o">=</span> <span class="n">kerfuffle</span>
<span class="nc">End</span> <span class="nc">Function</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This can be easily rewritten in Python as:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">decrypt_stage</span><span class="p">(</span><span class="n">stage2</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
	<span class="n">decrypted</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">len_key</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
	<span class="n">key_count</span> <span class="o">=</span> <span class="mi">0</span>

	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">stage2</span><span class="p">),</span> <span class="mi">4</span><span class="p">):</span>
		<span class="n">byte_at</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">stage2</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">pos</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">pos</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">byte_at</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">key_count</span> <span class="o">%</span> <span class="n">len_key</span><span class="p">]</span>
		
		<span class="n">decrypted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
		<span class="n">key_count</span> <span class="o">+=</span> <span class="mi">1</span>

		<span class="k">if</span> <span class="n">key_count</span> <span class="o">==</span> <span class="n">length</span><span class="p">:</span>
			<span class="k">break</span>

	<span class="k">return</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">decrypted</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The idea here is, we get a text, a length and where in the string we should split, because this will be a text in the hex format, and we just will decrypt the first byte of this 2 bytes, example:</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>b = "C4BA"
b[0+pos:2] ^ key# C4
</pre></td></tr></tbody></table></code></div></div>

<p>This is also using a XOR encryption using an block cipher, so we need to always make sure to stay in the range, using mod.</p>

<h2 id="decrypting-the-audio"><span class="mr-2">Decrypting the audio</span><a href="#decrypting-the-audio" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Just like before, I dumped the data using <a href="https://www.mitec.cz/ssv.html">ssviewer</a>, I edited the file to make it start at the <strong><em>58</em></strong> value, the start of <strong><em>L.Text</em></strong>(Look at the form again).</p>

<p><a href="/assets/images/vbastomping_flare_7/o_stream.png" class="popup img-link "><img data-src="/assets/images/vbastomping_flare_7/o_stream.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>Now, calling the function:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="n">key</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x11\x22\x33\x44\x55\x66\x77\x88\x99\xAA\xCC\xDD\xEE</span><span class="sh">"</span>

<span class="n">input_file</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">stage2_decrypted</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
<span class="n">size</span> <span class="o">=</span> 	<span class="mi">168667</span>
<span class="n">decrypted_stage2</span> <span class="o">=</span> <span class="nf">decrypt_stage</span><span class="p">(</span><span class="n">stage2_decrypted</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

    
<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">stage2.dec</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">sfd</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">decrypted_stage2</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">sfd</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">decrypted_stage2</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>I get this sound:</p>

<p><a href="/assets/images/vbastomping_flare_7/fake_stage2.png" class="popup img-link "><img data-src="/assets/images/vbastomping_flare_7/fake_stage2.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>The sound has only a random sounds, and the title is <strong><em>This is not what you should be looking at…</em></strong> and the Album title is <strong><em>P. Code</em></strong>.</p>

<h2 id="lets-talk-about-the-real-thing-here"><span class="mr-2">Let’s talk about the real thing here</span><a href="#lets-talk-about-the-real-thing-here" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Ok, forget about almost everything above, the real thing is… that this code above is fake.</p>

<p><a href="/assets/images/vbastomping_flare_7/vbastomp.png" class="popup img-link "><img data-src="/assets/images/vbastomping_flare_7/vbastomp.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<h1 id="vba-stomping">VBA Stomping</h1>

<p>After research a lot about <a href="https://en.wikipedia.org/wiki/P-code_machine">P-Code</a>, I discovered that VBA macros,  actually are compiled when the document is ready and not only hold the real code. The compiled code makes the run process faster if the person who open the document has the same VBA version.</p>

<p>That “feature” can be used to inject malicious code inside the document and write a fake source file to trick analysts and anti virus solutions, if the document has the same VBA version as the attacker, this code will be executed and using that is possible to hide the real code, this technique is called <a href="https://vbastomp.com/">VBA Stomping</a>.</p>

<p>We can dump the real P-Code with the amazing job created by <a href="https://github.com/bontchev">Dr. Vesselin Bontchev</a> the author of <a href="https://github.com/bontchev/pcodedmp">pcodedmp</a>, using this we can read the original source code. The P-Code has a format that remember ASM, so in order to get the almost exactly code as the macro, I found this another cool tool based in pcodedmp, <a href="https://github.com/Big5-sec/pcode2code">pcode2code</a>.</p>

<h2 id="the-code-in-p-code"><span class="mr-2">The code in P-Code</span><a href="#the-code-in-p-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Let’s use <strong><em>pcodedmp</em></strong> and get the real code:</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ pcode2code report.xls | tee real_code.vbs
</pre></td></tr></tbody></table></code></div></div>

<p>I will not dump the whole code again, because only certain things changed, the decrypt and decode table still the same, so we will use our previous work to get the flag.</p>

<div class="language-java highlighter-rouge"><div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="err">'</span> <span class="nc">Already</span> <span class="n">decoded</span> <span class="n">the</span> <span class="n">strings</span> <span class="n">looking</span> <span class="n">at</span> <span class="n">our</span> <span class="n">decode</span> <span class="n">table</span>
<span class="nc">Set</span> <span class="n">groke</span> <span class="o">=</span> <span class="nc">CreateObject</span><span class="o">(</span><span class="s">"WScript.Network"</span><span class="o">)</span>
<span class="n">firkin</span> <span class="o">=</span> <span class="n">groke</span><span class="o">.</span><span class="na">UserDomain</span>
<span class="nc">If</span> <span class="n">firkin</span> <span class="o">&lt;&gt;</span> <span class="s">"FLARE-ON"</span> <span class="nc">Then</span>
    <span class="nc">MsgBox</span> <span class="s">"Sorry, this machine is not supported."</span> <span class="n">vbCritical</span><span class="o">,</span> <span class="s">"Error"</span>
    <span class="nc">End</span>
<span class="nc">End</span> <span class="nc">If</span>

<span class="n">n</span> <span class="o">=</span> <span class="nc">Len</span><span class="o">(</span><span class="n">firkin</span><span class="o">)</span>
<span class="nc">For</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="nc">To</span> <span class="n">n</span>
    <span class="nf">buff</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">i</span><span class="o">)</span> <span class="o">=</span> <span class="nc">Asc</span><span class="o">(</span><span class="nc">Mid</span><span class="err">$</span><span class="o">(</span><span class="n">firkin</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="mi">1</span><span class="o">))</span>
<span class="nc">Next</span>

<span class="n">wabbit</span> <span class="o">=</span> <span class="n">canoodle</span><span class="o">(</span><span class="no">F</span><span class="o">.</span><span class="na">T</span><span class="o">.</span><span class="na">Text</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">285729</span><span class="o">,</span> <span class="n">buff</span><span class="o">)</span>
<span class="n">mf</span> <span class="o">=</span> <span class="nc">Environ</span><span class="o">(</span><span class="s">"AppData"</span> <span class="o">&amp;</span> <span class="s">"\Microsoft\v.png"</span><span class="o">)</span>
<span class="nc">Open</span> <span class="n">mf</span> <span class="nc">For</span> <span class="nc">Binary</span> <span class="nc">Lock</span> <span class="nc">Read</span> <span class="nc">Write</span> <span class="nc">As</span> <span class="err">#</span><span class="n">fn</span>
<span class="err">'</span> <span class="n">a</span> <span class="n">generic</span> <span class="n">exception</span> <span class="n">occured</span> <span class="n">at</span> <span class="n">line</span> <span class="mi">68</span><span class="o">:</span> <span class="n">can</span> <span class="n">only</span> <span class="n">concatenate</span> <span class="nf">str</span> <span class="o">(</span><span class="n">not</span> <span class="s">"NoneType"</span><span class="o">)</span> <span class="n">to</span> <span class="n">str</span>
<span class="err">'</span>	<span class="err">#</span> <span class="nc">Ld</span> <span class="n">fn</span>
<span class="err">'</span>	<span class="err">#</span> <span class="nc">Sharp</span>
<span class="err">'</span>	<span class="err">#</span> <span class="nc">LitDefault</span>
<span class="err">'</span>	<span class="err">#</span> <span class="nc">Ld</span> <span class="n">wabbit</span>
<span class="err">'</span>	<span class="err">#</span> <span class="nc">PutRec</span>
<span class="nc">Close</span> <span class="err">#</span><span class="n">fn</span>

<span class="nc">Set</span> <span class="n">panuding</span> <span class="o">=</span> <span class="nc">Sheet1</span><span class="o">.</span><span class="na">Shapes</span><span class="o">.</span><span class="na">AddPicture</span><span class="o">(</span><span class="n">mf</span><span class="o">,</span> <span class="nc">False</span><span class="o">,</span> <span class="nc">True</span><span class="o">,</span> <span class="mi">12</span><span class="o">,</span> <span class="mi">22</span><span class="o">,</span> <span class="mi">600</span><span class="o">,</span> <span class="mi">310</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>What has changed here?</p>

<ul>
  <li>It get the hostname and check if is equal to FLARE-ON</li>
  <li>The FLARE-ON name is reversed and its created an buff with their numbers values, in ascii</li>
  <li>The byte used to decrypt is in the second position</li>
  <li>The length of the output file is greater</li>
  <li>The key is the reversed FLARE-ON string</li>
</ul>

<p>Very cool, isn’t ?</p>

<h2 id="finally-the-real-flag"><span class="mr-2">Finally, the real flag</span><a href="#finally-the-real-flag" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Now, its just a matter to adapt the script to decrypt for us:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
	<span class="c1"># FLARE-ON
</span>	<span class="c1"># key = "FLARE-ON" 
</span>	<span class="n">key</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x4e\x4f\x2d\x45\x52\x41\x4c\x46</span><span class="sh">"</span> <span class="c1"># reversed
</span>
	<span class="n">input_file</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

	<span class="n">stage2_decrypted</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
	<span class="n">size</span> <span class="o">=</span> 	<span class="mi">285730</span>
	<span class="n">decrypted_stage2</span> <span class="o">=</span> <span class="nf">decrypt_stage</span><span class="p">(</span><span class="n">stage2_decrypted</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
	
		
	<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">stage2.dec</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">sfd</span><span class="p">:</span>
		<span class="nf">print</span><span class="p">(</span><span class="n">decrypted_stage2</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
		<span class="n">sfd</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">decrypted_stage2</span>
</pre></td></tr></tbody></table></code></div></div>

<p>And then:</p>

<p><a href="/assets/images/vbastomping_flare_7/real_flag.png" class="popup img-link "><img data-src="/assets/images/vbastomping_flare_7/real_flag.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>The decrypted flag image is</p>

<p><a href="/assets/images/vbastomping_flare_7/flag.png" class="popup img-link "><img data-src="/assets/images/vbastomping_flare_7/flag.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>That a very good example of this technique, I lost a lot of time just looking at the wrong place because I didn’t knew this about this technique, it’s very amazing how this works and a very clever evasion system, we see a lot anti virus solutions having trouble to analyze malicious scripts, can imagine how they will deal with a malicious code injected at the compiled code ?</p>

<p>I recommend the following resources:</p>

<ul>
  <li><a href="https://github.com/bontchev/pcodedmp">pcodedmp</a></li>
  <li><a href="https://www.fireeye.com/blog/threat-research/2020/01/stomp-2-dis-brilliance-in-the-visual-basics.html">stomp 2 dis</a></li>
  <li><a href="https://vbastomp.com/">vbastomp</a></li>
  <li><a href="https://medium.com/walmartglobaltech/vba-stomping-advanced-maldoc-techniques-612c484ab278">vba stomping by walmart</a></li>
</ul>

</div>

<div class="post-tail-wrapper text-muted">

  <!-- categories -->
  
  <div class="post-meta mb-3">
    <i class="far fa-folder-open fa-fw mr-1"></i>
    
      <a href='/categories/malware-research/'>Malware-Research</a>
  </div>
  

  <!-- tags -->
  
  <div class="post-tags">
    <i class="fa fa-tags fa-fw mr-1"></i>
      
      <a href="/tags/malware-analysis/"
          class="post-tag no-text-decoration" >Malware analysis</a>
      
      <a href="/tags/malware-research/"
          class="post-tag no-text-decoration" >Malware research</a>
      
      <a href="/tags/programming/"
          class="post-tag no-text-decoration" >Programming</a>
      
      <a href="/tags/reverse-engineering/"
          class="post-tag no-text-decoration" >Reverse engineering</a>
      
  </div>
  

  <div class="post-tail-bottom
    d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
    <div class="license-wrapper">

      

        

        This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.

      
    </div>

    <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=VBA%20Stomping:%20The%20macro%20hidden%20in%20plain%20sight%20-%20Reversing%20codes&url=https%3A%2F%2Freversing.codes%2Fposts%2FVBA-Stomping-flare%2F" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=VBA%20Stomping:%20The%20macro%20hidden%20in%20plain%20sight%20-%20Reversing%20codes&u=https%3A%2F%2Freversing.codes%2Fposts%2FVBA-Stomping-flare%2F" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://t.me/share/url?url=https%3A%2F%2Freversing.codes%2Fposts%2FVBA-Stomping-flare%2F&text=VBA%20Stomping:%20The%20macro%20hidden%20in%20plain%20sight%20-%20Reversing%20codes" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i id="copy-link" class="fa-fw fas fa-link small"
        data-toggle="tooltip" data-placement="top"
        title="Copy link"
        data-title-succeed="Link copied successfully!">
    </i>

  </span>
</div>


  </div><!-- .post-tail-bottom -->

</div><!-- div.post-tail-wrapper -->


      
    
    

    </div>
  </div> <!-- #core-wrapper -->

  <!-- panel -->
  <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">

    <div class="access">
      















  <div id="access-lastmod" class="post">
    <div class="panel-heading">Recently Updated</div>
    <ul class="post-content pl-0 pb-1 ml-1 mt-2">
      
        
        
        
      <li><a href="/posts/PlayStation-5-ELF-Injection/">Usermode ELF injection on the PlayStation 5</a></li>
      
        
        
        
      <li><a href="/posts/ps4-kernel-patching-guide/">How to patch the running PlayStation 4 kernel</a></li>
      
        
        
        
      <li><a href="/posts/Stop-Using-GetProcAddress-And-Let-The-Linker/">Quick Tip: Stop Using GetProcAddress and Let the Linker Do the Job for You</a></li>
      
        
        
        
      <li><a href="/posts/Manual-unpacking-in-details/">Manual Unpacking in Details</a></li>
      
        
        
        
      <li><a href="/posts/Manipulating-elf-with-felf/">Manipulating elf files in C++ using felf</a></li>
      
    </ul>
  </div> <!-- #access-lastmod -->



      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/programming/">Programming</a>
    
      
      <a class="post-tag" href="/tags/reverse-engineering/">Reverse engineering</a>
    
      
      <a class="post-tag" href="/tags/malware-research/">Malware Research</a>
    
      
      <a class="post-tag" href="/tags/ctf/">ctf</a>
    
      
      <a class="post-tag" href="/tags/windows-internals/">Windows Internals</a>
    
      
      <a class="post-tag" href="/tags/freebsd/">FreeBSD</a>
    
      
      <a class="post-tag" href="/tags/malware-analysis/">Malware analysis</a>
    
      
      <a class="post-tag" href="/tags/malware-research/">Malware research</a>
    
      
      <a class="post-tag" href="/tags/network-analysis/">Network analysis</a>
    
      
      <a class="post-tag" href="/tags/obfuscation-analysis/">obfuscation analysis</a>
    

    </div>
  </div>


    </div>

    
      
      



  <div id="toc-wrapper" class="pl-0 pr-4 mb-5">
    <div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
    <nav id="toc"></nav>
  </div>

  <!-- toc.js will be loaded at medium priority -->
  <script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script>


    
  </div>

</div>

<!-- tail -->

<div class="row">
  <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5">
    
      
      <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->





  <div id="related-posts" class="mb-2 mb-sm-4">
    <h3 class="pt-2 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/posts/Code-it-flare-7/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1603495416"
    data-df="ll"
    >
  Oct 23, 2020
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>The Flare 7th AutoIT challenge</h3>
            <div class="text-muted small">
              <p>
                





                The 7th challenge of Flare-On CTF, give to us a QR code generator software that are fully obfuscated, the fun part of this challenge was interpret, analyse and deobfuscate core components of the so...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/Retrieving-the-exfiltrated-flag-flareon7/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1603495536"
    data-df="ll"
    >
  Oct 23, 2020
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Data exfiltration: From shellcode to flag</h3>
            <div class="text-muted small">
              <p>
                





                At Flare 7th edition, my favorite challenge was re_crowd, this challenge was really close to a very real world scenario, with just an pcap we are able to understand how the company was attacked, wh...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/Manipulating-elf-with-felf/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1606759236"
    data-df="ll"
    >
  Nov 30, 2020
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Manipulating elf files in C++ using felf</h3>
            <div class="text-muted small">
              <p>
                





                A couple months ago I created felf, a library to parse ELF files into C++ structures, the reason for this was to have a way in C++ to work on ELF files using STL structures like vector, unordered m...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->


    
      
      <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/posts/Code-it-flare-7/" class="btn btn-outline-primary"
    prompt="Older">
    <p>The Flare 7th AutoIT challenge</p>
  </a>
  

  
  <a href="/posts/Retrieving-the-exfiltrated-flag-flareon7/" class="btn btn-outline-primary"
    prompt="Newer">
    <p>Data exfiltration: From shellcode to flag</p>
  </a>
  

</div>

    
      
      <!--  The comments switcher -->


    
  </div>
</div>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/programming/">Programming</a>
    
      
      <a class="post-tag" href="/tags/reverse-engineering/">Reverse engineering</a>
    
      
      <a class="post-tag" href="/tags/malware-research/">Malware Research</a>
    
      
      <a class="post-tag" href="/tags/ctf/">ctf</a>
    
      
      <a class="post-tag" href="/tags/windows-internals/">Windows Internals</a>
    
      
      <a class="post-tag" href="/tags/freebsd/">FreeBSD</a>
    
      
      <a class="post-tag" href="/tags/malware-analysis/">Malware analysis</a>
    
      
      <a class="post-tag" href="/tags/malware-research/">Malware research</a>
    
      
      <a class="post-tag" href="/tags/network-analysis/">Network analysis</a>
    
      
      <a class="post-tag" href="/tags/obfuscation-analysis/">obfuscation analysis</a>
    

    </div>
  </div>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    <!-- The Footer -->

<footer>
  <div class="container pl-lg-4 pr-lg-4">
    <div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3">
      <div class="footer-left">
        <p class="mb-0">
          © 2025
          <a href="https://github.com/buzzer-re">Buzzer</a>.
          
          <span data-toggle="tooltip" data-placement="top"
            title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
          
        </p>
      </div>

      <div class="footer-right">
        <p class="mb-0">Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>.
        </p>
      </div>
    </div>
  </div>
</footer>


    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    
      <div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true"
        data-animation="true" data-autohide="false">
        <div class="toast-header">
          <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="toast-body text-center pt-0">
          <p class="pl-2 pr-2 mb-3">A new version of content is available.</p>
          <button type="button" class="btn btn-primary" aria-label="Update">
            Update
          </button>
        </div>
      </div>
    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No results found.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


    <!-- JS selector for site. -->

<!-- layout specified -->


  



  <!-- image lazy-loading & popup & clipboard -->
  

  







  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js"></script>





  

  

  







  
    

    

  



  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1.11.6/dayjs.min.js,npm/dayjs@1.11.6/locale/en.min.js,npm/dayjs@1.11.6/plugin/relativeTime.min.js,npm/dayjs@1.11.6/plugin/localizedFormat.min.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>



<!-- commons -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>




  </body>

</html>

